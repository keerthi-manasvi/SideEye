#!/usr/bin/env node

const { spawn, exec } = require('child_process');
const fs = require('fs');
const path = require('path');
const os = require('os');

/**
 * Installation script for Python dependencies
 * Handles Django backend requirements installation across platforms
 */

const platform = os.platform();
const isWindows = platform === 'win32';
const isMac = platform === 'darwin';
const isLinux = platform === 'linux';

// Python executable names to try
const pythonExecutables = isWindows 
  ? ['python', 'python3', 'py'] 
  : ['python3', 'python'];

// Pip executable names to try
const pipExecutables = isWindows 
  ? ['pip', 'pip3', 'py -m pip'] 
  : ['pip3', 'pip'];

class PythonInstaller {
  constructor() {
    this.pythonPath = null;
    this.pipPath = null;
    this.requirementsPath = path.join(__dirname, '..', 'backend', 'requirements.txt');
  }

  async checkPython() {
    console.log('ðŸ” Checking for Python installation...');
    
    for (const executable of pythonExecutables) {
      try {
        const version = await this.runCommand(executable, ['--version']);
        if (version.includes('Python 3.')) {
          this.pythonPath = executable;
          console.log(`âœ… Found Python: ${version.trim()}`);
          return true;
        }
      } catch (error) {
        // Continue to next executable
      }
    }
    
    console.error('âŒ Python 3.x not found. Please install Python 3.7 or higher.');
    return false;
  }

  async checkPip() {
    console.log('ðŸ” Checking for pip installation...');
    
    for (const executable of pipExecutables) {
      try {
        const version = await this.runCommand(executable, ['--version']);
        if (version.includes('pip')) {
          this.pipPath = executable;
          console.log(`âœ… Found pip: ${version.trim()}`);
          return true;
        }
      } catch (error) {
        // Continue to next executable
      }
    }
    
    console.error('âŒ pip not found. Please install pip.');
    return false;
  }

  async installDependencies() {
    if (!fs.existsSync(this.requirementsPath)) {
      console.error(`âŒ Requirements file not found: ${this.requirementsPath}`);
      return false;
    }

    console.log('ðŸ“¦ Installing Python dependencies...');
    
    try {
      // Create virtual environment if it doesn't exist
      const venvPath = path.join(__dirname, '..', 'backend', 'venv');
      
      if (!fs.existsSync(venvPath)) {
        console.log('ðŸ”§ Creating virtual environment...');
        await this.runCommand(this.pythonPath, ['-m', 'venv', venvPath]);
      }

      // Determine activation script path
      const activateScript = isWindows 
        ? path.join(venvPath, 'Scripts', 'activate.bat')
        : path.join(venvPath, 'bin', 'activate');

      const pipInVenv = isWindows
        ? path.join(venvPath, 'Scripts', 'pip.exe')
        : path.join(venvPath, 'bin', 'pip');

      // Install requirements in virtual environment
      console.log('ðŸ“¥ Installing requirements in virtual environment...');
      await this.runCommand(pipInVenv, ['install', '-r', this.requirementsPath]);
      
      console.log('âœ… Python dependencies installed successfully!');
      
      // Create activation helper script
      this.createActivationHelper(venvPath);
      
      return true;
    } catch (error) {
      console.error('âŒ Failed to install Python dependencies:', error.message);
      
      // Fallback: try system-wide installation
      console.log('ðŸ”„ Attempting system-wide installation as fallback...');
      try {
        await this.runCommand(this.pipPath, ['install', '-r', this.requirementsPath, '--user']);
        console.log('âœ… Python dependencies installed system-wide!');
        return true;
      } catch (fallbackError) {
        console.error('âŒ System-wide installation also failed:', fallbackError.message);
        return false;
      }
    }
  }

  createActivationHelper(venvPath) {
    const helperPath = path.join(__dirname, '..', 'backend', 'activate-venv.js');
    const activateScript = isWindows 
      ? path.join(venvPath, 'Scripts', 'activate.bat')
      : path.join(venvPath, 'bin', 'activate');

    const helperContent = `#!/usr/bin/env node

/**
 * Virtual environment activation helper
 * This file is auto-generated by install-python-deps.js
 */

const path = require('path');
const os = require('os');

const isWindows = os.platform() === 'win32';
const venvPath = '${venvPath.replace(/\\/g, '\\\\')}';

function getVenvPython() {
  return isWindows 
    ? path.join(venvPath, 'Scripts', 'python.exe')
    : path.join(venvPath, 'bin', 'python');
}

function getVenvPip() {
  return isWindows 
    ? path.join(venvPath, 'Scripts', 'pip.exe')
    : path.join(venvPath, 'bin', 'pip');
}

function getActivateScript() {
  return isWindows 
    ? path.join(venvPath, 'Scripts', 'activate.bat')
    : path.join(venvPath, 'bin', 'activate');
}

module.exports = {
  venvPath,
  getVenvPython,
  getVenvPip,
  getActivateScript
};
`;

    fs.writeFileSync(helperPath, helperContent);
    console.log(`ðŸ“ Created virtual environment helper: ${helperPath}`);
  }

  async runCommand(command, args) {
    return new Promise((resolve, reject) => {
      const process = spawn(command, args, { 
        stdio: ['pipe', 'pipe', 'pipe'],
        shell: isWindows 
      });
      
      let stdout = '';
      let stderr = '';
      
      process.stdout.on('data', (data) => {
        stdout += data.toString();
      });
      
      process.stderr.on('data', (data) => {
        stderr += data.toString();
      });
      
      process.on('close', (code) => {
        if (code === 0) {
          resolve(stdout);
        } else {
          reject(new Error(stderr || `Command failed with code ${code}`));
        }
      });
      
      process.on('error', (error) => {
        reject(error);
      });
    });
  }

  async install() {
    console.log('ðŸš€ Starting Python dependencies installation...\n');
    
    const pythonOk = await this.checkPython();
    if (!pythonOk) {
      this.printInstallationInstructions();
      process.exit(1);
    }
    
    const pipOk = await this.checkPip();
    if (!pipOk) {
      this.printInstallationInstructions();
      process.exit(1);
    }
    
    const installOk = await this.installDependencies();
    if (!installOk) {
      console.error('\nâŒ Installation failed. Please check the error messages above.');
      process.exit(1);
    }
    
    console.log('\nðŸŽ‰ Python dependencies installation completed successfully!');
    console.log('\nðŸ“‹ Next steps:');
    console.log('   1. Run "npm run first-run-setup" to complete initial setup');
    console.log('   2. Run "npm run dev" to start the development environment');
  }

  printInstallationInstructions() {
    console.log('\nðŸ“– Python Installation Instructions:');
    console.log('');
    
    if (isWindows) {
      console.log('Windows:');
      console.log('  1. Download Python from https://python.org/downloads/');
      console.log('  2. Make sure to check "Add Python to PATH" during installation');
      console.log('  3. Restart your command prompt and try again');
    } else if (isMac) {
      console.log('macOS:');
      console.log('  1. Install Homebrew: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"');
      console.log('  2. Install Python: brew install python3');
      console.log('  3. Try the installation again');
    } else if (isLinux) {
      console.log('Linux:');
      console.log('  Ubuntu/Debian: sudo apt update && sudo apt install python3 python3-pip python3-venv');
      console.log('  CentOS/RHEL: sudo yum install python3 python3-pip');
      console.log('  Arch: sudo pacman -S python python-pip');
    }
    
    console.log('');
    console.log('After installing Python, run "npm run postinstall" again.');
  }
}

// Run installation if called directly
if (require.main === module) {
  const installer = new PythonInstaller();
  installer.install().catch(error => {
    console.error('ðŸ’¥ Installation failed:', error.message);
    process.exit(1);
  });
}

module.exports = PythonInstaller;